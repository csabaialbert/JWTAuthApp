# .github/workflows/ci-cd-pipeline-final.yml

name: .NET API CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'API/**'
      - 'client/**'
      - 'Dockerfile*'
      - 'docker-compose.yml'
      - '.github/workflows/**'

permissions:
  contents: read
  packages: write

jobs:
  # -----------------------------------------------------
  # 1. CI FÁZIS: Buildelés és Unit Tesztelés
  # -----------------------------------------------------
  build_and_test_api:
    runs-on: ubuntu-latest

    env:
      TZ: Europe/Budapest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies and Publish
        run: dotnet publish API/API.csproj --configuration Release -o publish_output

      - name: Run Unit Tests
        run: dotnet test JWTAUTH.API.Tests/JWTAUTH.API.Tests.csproj --configuration Release --no-build

      - name: Publish API Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-api-build
          path: publish_output

  # -----------------------------------------------------
  # 2. CI FÁZIS: Angular Buildelés
  # -----------------------------------------------------
  build_angular:
    runs-on: ubuntu-latest
    needs: [build_and_test_api]

    defaults:
      run:
        working-directory: client

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm install

      - name: Angular Production Build
        run: npm run build -- --configuration production --output-path dist/client

      # defaults.working-directory miatt itt elég a dist/client
      - name: Upload Angular Artifact
        uses: actions/upload-artifact@v4
        with:
          name: angular-build
          path: client/dist/client

  # -----------------------------------------------------
  # 3. CD FÁZIS: .NET API Docker Image Build & Push
  # -----------------------------------------------------
  docker_api_build:
    runs-on: ubuntu-latest
    needs: [build_and_test_api]

    steps:
      - name: Get Lowercase Repository Name
        id: repo_name_step
        run: echo "repo_name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4

      - name: Download API Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-api-build
          path: publish_input

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ steps.repo_name_step.outputs.repo_name }}/jwt-auth-api:latest
          file: ./Dockerfile
          build-args: |
            PUBLISH_DIR=publish_input

  # -----------------------------------------------------
  # 4. CD FÁZIS: Angular Frontend Docker Image Build & Push
  # -----------------------------------------------------
  docker_frontend_build:
    runs-on: ubuntu-latest
    needs: [build_angular]

    steps:
      - name: Get Lowercase Repository Name
        id: repo_name_step
        run: echo "repo_name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4

      - name: Download Angular Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: angular-build
          path: ./frontend_input

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ steps.repo_name_step.outputs.repo_name }}/jwt-auth-frontend:latest
          file: ./Dockerfile.frontend
          build-args: |
            ANGULAR_BUILD_DIR=frontend_input

  # -----------------------------------------------------
  # 5. E2E FÁZIS: End-to-End Tesztelés
  # -----------------------------------------------------
  e2e_testing:
    runs-on: ubuntu-latest
    needs: [docker_api_build, docker_frontend_build]

    steps:
      - uses: actions/checkout@v4

      - name: Get Lowercase Repository Name
        id: repo_name_step
        run: echo "repo_name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start Docker Compose Environment
        run: |
          API_IMAGE=ghcr.io/${{ steps.repo_name_step.outputs.repo_name }}/jwt-auth-api:latest
          FRONTEND_IMAGE=ghcr.io/${{ steps.repo_name_step.outputs.repo_name }}/jwt-auth-frontend:latest

          sed -i "s|YOUR_API_IMAGE|$API_IMAGE|g" docker-compose.yml
          sed -i "s|YOUR_FRONTEND_IMAGE|$FRONTEND_IMAGE|g" docker-compose.yml

          docker compose pull
          docker compose up -d

      - name: Wait for services to be ready
        run: sleep 30

      - name: Run E2E Tests (Cypress/Playwright)
        run: |
          npm install
          npm run e2e
        working-directory: client

      - name: Clean up Docker Compose
        if: always()
        run: docker compose down
